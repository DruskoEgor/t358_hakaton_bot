const { Bot, Keyboard } = require('@maxhub/max-bot-api');
const fs = require('fs');
const path = require('path');

const botToken = process.env.BOT_TOKEN;

if (!botToken) {
    console.error('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    process.exit(1);
}

const bot = new Bot(botToken);
const dataFile = path.join(__dirname, 'data.json');

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–º–æ—â–∏
const CATEGORIES = {
    CHILDREN: 'children',
    ELDERLY: 'elderly',
    DISABLED: 'disabled',
    ANIMALS: 'animals',
    NATURE: 'nature'
};

const CATEGORY_NAMES = {
    [CATEGORIES.CHILDREN]: 'üë∂ –î–µ—Ç—è–º',
    [CATEGORIES.ELDERLY]: 'üëµ –ü–æ–∂–∏–ª—ã–º –ª—é–¥—è–º',
    [CATEGORIES.DISABLED]: '‚ôø –õ—é–¥—è–º —Å –û–í–ó',
    [CATEGORIES.ANIMALS]: 'üêæ –ñ–∏–≤–æ—Ç–Ω—ã–º',
    [CATEGORIES.NATURE]: 'üå≥ –ü—Ä–∏—Ä–æ–¥–µ'
};

// –û–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã
const DISTRICTS = {
    CAO: '–¶–ê–û',
    SAO: '–°–ê–û', 
    SVAO: '–°–í–ê–û',
    VAO: '–í–ê–û',
    YUVAO: '–Æ–í–ê–û',
    YUAO: '–Æ–ê–û',
    YUZAO: '–Æ–ó–ê–û',
    ZAO: '–ó–ê–û',
    SZAO: '–°–ó–ê–û',
    ZELAO: '–ó–µ–ª–ê–û'
};

const DISTRICT_NAMES = {
    [DISTRICTS.CAO]: 'üèõÔ∏è –¶–ê–û (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)',
    [DISTRICTS.SAO]: 'üåÉ –°–ê–û (–°–µ–≤–µ—Ä–Ω—ã–π)',
    [DISTRICTS.SVAO]: 'üè¢ –°–í–ê–û (–°–µ–≤–µ—Ä–æ-–í–æ—Å—Ç–æ—á–Ω—ã–π)',
    [DISTRICTS.VAO]: 'üåÖ –í–ê–û (–í–æ—Å—Ç–æ—á–Ω—ã–π)',
    [DISTRICTS.YUVAO]: 'üè≠ –Æ–í–ê–û (–Æ–≥–æ-–í–æ—Å—Ç–æ—á–Ω—ã–π)',
    [DISTRICTS.YUAO]: 'üèòÔ∏è –Æ–ê–û (–Æ–∂–Ω—ã–π)',
    [DISTRICTS.YUZAO]: 'üéì –Æ–ó–ê–û (–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–π)',
    [DISTRICTS.ZAO]: 'üíº –ó–ê–û (–ó–∞–ø–∞–¥–Ω—ã–π)',
    [DISTRICTS.SZAO]: 'üå≤ –°–ó–ê–û (–°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–Ω—ã–π)',
    [DISTRICTS.ZELAO]: 'üåø –ó–µ–ª–ê–û (–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥—Å–∫–∏–π)'
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
function loadData() {
  try {
    if (fs.existsSync(dataFile)) {
      const data = fs.readFileSync(dataFile, 'utf8');
      return JSON.parse(data);
    }
  } catch (error) {}
  return { 
    requests: [],
    acceptedUsers: [],
    responses: []
  };
}

function saveData(data) {
  try {
    fs.writeFileSync(dataFile, JSON.stringify(data, null, 2));
  } catch (error) {}
}

function addRequest(userData, problem, phone, category, district) {
  const data = loadData();
  const newRequest = {
    id: Date.now(),
    user_id: userData.user_id,
    first_name: userData.first_name,
    problem: problem,
    phone: phone,
    category: category,
    district: district,
    timestamp: Date.now(),
    rating: 0,
    active: true,
    reserved: null
  };

  data.requests.push(newRequest);
  saveData(data);
  return newRequest;
}

function getSortedRequests(category = null, district = null) {
  const data = loadData();
  let requests = data.requests.filter(request => request.active && !request.reserved);

  if (category && Object.values(CATEGORIES).includes(category)) {
    requests = requests.filter(request => request.category === category);
  }

  if (district && Object.values(DISTRICTS).includes(district)) {
    requests = requests.filter(request => request.district === district);
  }

  return requests.sort((a, b) => {
    if (a.rating !== b.rating) {
      return b.rating - a.rating;
    }
    return a.timestamp - b.timestamp;
  });
}

function getUserRequests(userId) {
  const data = loadData();
  return data.requests
    .filter(request => request.user_id === userId)
    .sort((a, b) => b.timestamp - a.timestamp);
}

function deleteRequest(requestId, userId) {
  const data = loadData();
  const initialLength = data.requests.length;

  data.requests = data.requests.filter(request =>
    !(request.id === requestId && request.user_id === userId)
  );

  if (data.requests.length < initialLength) {
    saveData(data);
    return true;
  }
  return false;
}

function reserveRequest(requestId, userId) {
  const data = loadData();
  const request = data.requests.find(req => req.id === requestId);
  if (request && !request.reserved) {
    request.reserved = userId;
    
    const newResponse = {
      id: Date.now(),
      user_id: userId,
      request_id: requestId,
      timestamp: Date.now(),
      active: true
    };
    
    if (!data.responses) data.responses = [];
    data.responses.push(newResponse);
    
    saveData(data);
    return true;
  }
  return false;
}

function cancelReservation(requestId, userId) {
  const data = loadData();
  const request = data.requests.find(req => req.id === requestId);
  if (request && request.reserved === userId) {
    request.reserved = null;
    
    if (data.responses) {
      const response = data.responses.find(resp => 
        resp.request_id === requestId && resp.user_id === userId && resp.active
      );
      if (response) {
        response.active = false;
      }
    }
    
    saveData(data);
    return true;
  }
  return false;
}

function getUserResponses(userId) {
  const data = loadData();
  if (!data.responses) return [];
  
  return data.responses.filter(response => 
    response.user_id === userId && response.active
  );
}

function getRequestResponses(requestId) {
  const data = loadData();
  if (!data.responses) return [];
  
  return data.responses.filter(response => 
    response.request_id === requestId && response.active
  );
}

function hasUserResponded(userId, requestId) {
  const data = loadData();
  if (!data.responses) return false;
  
  return data.responses.some(response => 
    response.user_id === userId && 
    response.request_id === requestId && 
    response.active
  );
}

function validatePhone(phone) {
  const cleanedPhone = phone.replace(/[^\d+]/g, '');
  const phoneRegex = /^(\+7|7|8)?[\s\-]?\(?[489][0-9]{2}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$/;

  if (!phoneRegex.test(phone)) {
    return false;
  }

  const digitsOnly = cleanedPhone.replace(/\D/g, '');
  const digitsCount = digitsOnly.length;

  if (digitsOnly.startsWith('7') || digitsOnly.startsWith('8')) {
    return digitsCount === 11;
  } else if (digitsOnly.startsWith('+7')) {
    return digitsCount === 12;
  } else {
    return digitsCount === 10;
  }
}

function formatPhone(phone) {
  const digitsOnly = phone.replace(/\D/g, '');

  if (digitsOnly.startsWith('7') && digitsOnly.length === 11) {
    return `+7 (${digitsOnly.slice(1, 4)}) ${digitsOnly.slice(4, 7)}-${digitsOnly.slice(7, 9)}-${digitsOnly.slice(9)}`;
  } else if (digitsOnly.startsWith('8') && digitsOnly.length === 11) {
    return `+7 (${digitsOnly.slice(1, 4)}) ${digitsOnly.slice(4, 7)}-${digitsOnly.slice(7, 9)}-${digitsOnly.slice(9)}`;
  } else if (digitsOnly.length === 10) {
    return `+7 (${digitsOnly.slice(0, 3)}) ${digitsOnly.slice(3, 6)}-${digitsOnly.slice(6, 8)}-${digitsOnly.slice(8)}`;
  } else {
    return phone;
  }
}

function hasUserAcceptedAgreement(userId) {
  const data = loadData();
  return data.acceptedUsers && data.acceptedUsers.includes(userId);
}

function acceptUserAgreement(userId) {
  const data = loadData();
  if (!data.acceptedUsers) data.acceptedUsers = [];
  
  if (!data.acceptedUsers.includes(userId)) {
    data.acceptedUsers.push(userId);
    saveData(data);
  }
}

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userStates = new Map();
const userViewStates = new Map();
const userMyRequestsViewStates = new Map();

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
bot.api.setMyCommands([
  { name: 'start', description: '–ù–∞—á–∞—Ç—å –ø–æ–º–æ–≥–∞—Ç—å' },
  { name: 'about', description: '–æ –±–æ—Ç–µ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö' },
  { name: 'help_offer', description: '–•–æ—á—É –ø–æ–º–æ—á—å' },
  { name: 'need_help', description: '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å' },
  { name: 'profile', description: '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å' },
]);

// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========

bot.command('start', async (ctx) => {
  const user = ctx.message.sender;
  
  if (!hasUserAcceptedAgreement(user.user_id)) {
    await showUserAgreement(ctx);
    return;
  }
  
  userStates.delete(user.user_id);
  userViewStates.delete(user.user_id);
  userMyRequestsViewStates.delete(user.user_id);
  await showMainMenu(ctx);
});

bot.command('about', async (ctx) => {
  return await ctx.reply('–≠—Ç–æ –±–æ—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–∞ –Ω–∞ —Ä–∞–π–æ–Ω–µ, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ - –∫–æ–º–∞–Ω–¥–∞ –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç —Å–¥–µ–ª–∞—Ç—å –º–∏—Ä –ª—É—á—à–µ');
});

bot.command('help_offer', async (ctx) => {
  await showLocationSelection(ctx, 'help');
});

bot.command('need_help', async (ctx) => {
  await showLocationSelection(ctx, 'need');
});

bot.command('profile', async (ctx) => {
  await showProfile(ctx);
});

// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö CALLBACK-–ö–ù–û–ü–û–ö ==========

bot.on('message_callback', async (ctx) => {
  const callbackData = ctx.update.callback?.payload;
  const user = ctx.update.callback?.user;

  if (!callbackData) return;

  try {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è
    if (callbackData === 'accept_agreement') {
      const userId = user?.user_id;
      if (userId) {
        acceptUserAgreement(userId);
        await ctx.reply('‚úÖ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º.');
        await showMainMenu(ctx);
      }
      return;
    } else if (callbackData === 'decline_agreement') {
      await ctx.reply('‚ùå –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ.\n\n–ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start —Å–Ω–æ–≤–∞.');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è
    const userId = user?.user_id;
    if (userId && !hasUserAcceptedAgreement(userId)) {
      await showUserAgreement(ctx);
      return;
    }

    // –û—Å–Ω–æ–≤–Ω—ã–µ callback-–¥–µ–π—Å—Ç–≤–∏—è
    if (callbackData === 'want_to_help') {
      await showLocationSelection(ctx, 'help');
    } else if (callbackData === 'need_help') {
      await showLocationSelection(ctx, 'need');
    } else if (callbackData === 'profile') {
      await showProfile(ctx);
    } else if (callbackData === 'my_requests') {
      await showMyRequests(ctx, 0);
    } else if (callbackData === 'my_responses') {
      await showMyResponses(ctx, 0);
    } else if (callbackData === 'moscow') {
      // –í—ã–±–æ—Ä –ú–æ—Å–∫–≤—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫—Ä—É–≥–∞
      const actionType = ctx.update.callback?.payload.split('_')[1];
      await showDistrictSelection(ctx, actionType);
    } else if (callbackData.startsWith('district_')) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–∫—Ä—É–≥–∞
      const parts = callbackData.split('_');
      const actionType = parts[1];
      const district = parts[2];

      if (actionType === 'help') {
        await showCategorySelection(ctx, 'help', district);
      } else if (actionType === 'need') {
        await showCategorySelection(ctx, 'need', district);
      }
    } else if (callbackData.startsWith('category_')) {
      const parts = callbackData.split('_');
      const action = parts[1];
      const category = parts[2];
      const district = parts[3];

      if (action === 'help') {
        await showHelpRequest(ctx, 0, category, district);
      } else if (action === 'need') {
        const userId = user?.user_id;
        if (userId) {
          userStates.set(userId, {
            step: 'waiting_for_problem',
            category: category,
            district: district
          });
          await ctx.reply(`–í—ã –≤—ã–±—Ä–∞–ª–∏:\nüìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${CATEGORY_NAMES[category]}\nüìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[district]}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É:`);
        }
      }
    } else if (callbackData.startsWith('next_')) {
      const parts = callbackData.split('_');
      const index = parseInt(parts[1]);
      const category = parts[2] || null;
      const district = parts[3] || null;
      await showHelpRequest(ctx, index, category, district);
    } else if (callbackData.startsWith('prev_')) {
      const parts = callbackData.split('_');
      const index = parseInt(parts[1]);
      const category = parts[2] || null;
      const district = parts[3] || null;
      await showHelpRequest(ctx, index, category, district);
    } else if (callbackData.startsWith('my_next_')) {
      const index = parseInt(callbackData.split('_')[2]);
      await showMyRequests(ctx, index);
    } else if (callbackData.startsWith('my_prev_')) {
      const index = parseInt(callbackData.split('_')[2]);
      await showMyRequests(ctx, index);
    } else if (callbackData.startsWith('resp_next_')) {
      const index = parseInt(callbackData.split('_')[2]);
      await showMyResponses(ctx, index);
    } else if (callbackData.startsWith('resp_prev_')) {
      const index = parseInt(callbackData.split('_')[2]);
      await showMyResponses(ctx, index);
    } else if (callbackData.startsWith('delete_')) {
      const requestId = parseInt(callbackData.split('_')[1]);
      await deleteMyRequest(ctx, requestId);
    } else if (callbackData.startsWith('respond_')) {
      const requestId = parseInt(callbackData.split('_')[1]);
      await respondToRequest(ctx, requestId);
    } else if (callbackData.startsWith('cancel_response_')) {
      const requestId = parseInt(callbackData.split('_')[2]);
      await cancelResponse(ctx, requestId);
    } else if (callbackData === 'back_to_start') {
      await showMainMenu(ctx);
    } else if (callbackData === 'return_after_request') {
      await showMainMenu(ctx);
    } else if (callbackData === 'back_to_profile') {
      await showProfile(ctx);
    } else if (callbackData === 'back_to_categories_help') {
      const parts = callbackData.split('_');
      const district = parts[3];
      await showCategorySelection(ctx, 'help', district);
    } else if (callbackData === 'back_to_categories_need') {
      const parts = callbackData.split('_');
      const district = parts[3];
      await showCategorySelection(ctx, 'need', district);
    } else if (callbackData === 'back_to_location_help') {
      await showLocationSelection(ctx, 'help');
    } else if (callbackData === 'back_to_location_need') {
      await showLocationSelection(ctx, 'need');
    } else if (callbackData === 'back_to_districts_help') {
      await showDistrictSelection(ctx, 'help');
    } else if (callbackData === 'back_to_districts_need') {
      await showDistrictSelection(ctx, 'need');
    }
  } catch (error) {
    await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. ‚ùå');
  }
});

// ========== –§–£–ù–ö–¶–ò–ò –ü–û–ö–ê–ó–ê –ò–ù–¢–ï–†–§–ï–ô–°–û–í ==========

async function showUserAgreement(ctx) {
  const user = ctx.message.sender;
  
  const agreementText = `
üìú **–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–û–ï –°–û–ì–õ–ê–®–ï–ù–ò–ï**

–ù–∞—Å—Ç–æ—è—â–∏–º —è, ${user.first_name}, –¥–∞—é —Å–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º –∑–∞–∫–æ–Ω–æ–º –æ—Ç 27.07.2006 ‚Ññ 152-–§–ó ¬´–û –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö¬ª.

**1. –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- –§–∞–º–∏–ª–∏—è, –∏–º—è
- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –ò–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –º–Ω–æ–π –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞

**2. –¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- –û–∫–∞–∑–∞–Ω–∏–µ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–æ–π –ø–æ–º–æ—â–∏
- –°–≤—è–∑—å –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –ø–æ–º–æ—â–∏
- –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–∞

**3. –ü–µ—Ä–µ–¥–∞—á–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
–Ø —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å —Ç–µ–º, —á—Ç–æ –º–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏ –æ—Ç–∫–ª–∏–∫–µ –Ω–∞ –º–æ—é –∑–∞—è–≤–∫—É –æ –ø–æ–º–æ—â–∏.

**4. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–æ–≥–ª–∞—Å–∏—è:**
–°–æ–≥–ª–∞—Å–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–∑—ã–≤–∞ –ø—É—Ç–µ–º —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.

–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–Ω—è—Ç—å", —è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω(–∞) —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
  `;

  const keyboard = Keyboard.inlineKeyboard([
    [
      Keyboard.button.callback('‚úÖ –ü—Ä–∏–Ω—è—Ç—å', 'accept_agreement'),
      Keyboard.button.callback('‚ùå –ù–∞–∑–∞–¥', 'decline_agreement')
    ]
  ]);

  await ctx.reply(agreementText, { attachments: [keyboard] });
}

async function showMainMenu(ctx) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (user?.user_id) {
    userStates.delete(user.user_id);
    userViewStates.delete(user.user_id);
    userMyRequestsViewStates.delete(user.user_id);
  }

  const keyboard = Keyboard.inlineKeyboard([
    [
      Keyboard.button.callback('–•–æ—á—É –ø–æ–º–æ—á—å', 'want_to_help'),
      Keyboard.button.callback('–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å', 'need_help')
    ],
    [
      Keyboard.button.callback('üë§ –ü—Ä–æ—Ñ–∏–ª—å', 'profile')
    ]
  ]);

  const message = user ?
    `–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ß—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ, ${user.first_name}?` :
    '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ß—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ?';

  await ctx.reply(message, { attachments: [keyboard] });
}

async function showLocationSelection(ctx, actionType) {
  const actionText = actionType === 'help' ? '–•–æ—á—É –ø–æ–º–æ—á—å' : '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å';

  const keyboard = Keyboard.inlineKeyboard([
    [
      Keyboard.button.callback('üèôÔ∏è –ú–æ—Å–∫–≤–∞', `moscow_${actionType}`)
    ],
    [
      Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')
    ]
  ]);

  await ctx.reply(
    `${actionText}\n\n` +
    `üìç **–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥, –≥–¥–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–º–æ–≥–∞—Ç—å:**\n\n` +
    `–ü–æ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ú–æ—Å–∫–≤–∞. –í –±—É–¥—É—â–µ–º –¥–æ–±–∞–≤–∏–º –¥—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞.`,
    { attachments: [keyboard] }
  );
}

async function showDistrictSelection(ctx, actionType) {
  const actionText = actionType === 'help' ? '–•–æ—á—É –ø–æ–º–æ—á—å' : '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å';

  const keyboard = Keyboard.inlineKeyboard([
    [
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.CAO], `district_${actionType}_${DISTRICTS.CAO}`),
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.SAO], `district_${actionType}_${DISTRICTS.SAO}`)
    ],
    [
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.SVAO], `district_${actionType}_${DISTRICTS.SVAO}`),
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.VAO], `district_${actionType}_${DISTRICTS.VAO}`)
    ],
    [
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.YUVAO], `district_${actionType}_${DISTRICTS.YUVAO}`),
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.YUAO], `district_${actionType}_${DISTRICTS.YUAO}`)
    ],
    [
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.YUZAO], `district_${actionType}_${DISTRICTS.YUZAO}`),
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.ZAO], `district_${actionType}_${DISTRICTS.ZAO}`)
    ],
    [
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.SZAO], `district_${actionType}_${DISTRICTS.SZAO}`),
      Keyboard.button.callback(DISTRICT_NAMES[DISTRICTS.ZELAO], `district_${actionType}_${DISTRICTS.ZELAO}`)
    ],
    [
      Keyboard.button.callback('üèôÔ∏è –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥', `back_to_location_${actionType}`),
      Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')
    ]
  ]);

  await ctx.reply(
    `${actionText}\n\n` +
    `üìç **–í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–≥ –ú–æ—Å–∫–≤—ã:**\n\n` +
    `–£–∫–∞–∂–∏—Ç–µ, –≤ –∫–∞–∫–æ–º –æ–∫—Ä—É–≥–µ –≤—ã –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ–≥–∞—Ç—å –∏–ª–∏ –≥–¥–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å`,
    { attachments: [keyboard] }
  );
}

async function showCategorySelection(ctx, actionType, district) {
  const actionText = actionType === 'help' ? '–•–æ—á—É –ø–æ–º–æ—á—å' : '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å';
  const districtName = DISTRICT_NAMES[district];

  const keyboard = Keyboard.inlineKeyboard([
    [
      Keyboard.button.callback(CATEGORY_NAMES[CATEGORIES.CHILDREN], `category_${actionType}_${CATEGORIES.CHILDREN}_${district}`),
      Keyboard.button.callback(CATEGORY_NAMES[CATEGORIES.ELDERLY], `category_${actionType}_${CATEGORIES.ELDERLY}_${district}`)
    ],
    [
      Keyboard.button.callback(CATEGORY_NAMES[CATEGORIES.DISABLED], `category_${actionType}_${CATEGORIES.DISABLED}_${district}`),
      Keyboard.button.callback(CATEGORY_NAMES[CATEGORIES.ANIMALS], `category_${actionType}_${CATEGORIES.ANIMALS}_${district}`)
    ],
    [
      Keyboard.button.callback(CATEGORY_NAMES[CATEGORIES.NATURE], `category_${actionType}_${CATEGORIES.NATURE}_${district}`)
    ],
    [
      Keyboard.button.callback('üìç –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ–∫—Ä—É–≥', `back_to_districts_${actionType}`),
      Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')
    ]
  ]);

  await ctx.reply(
    `${actionText}\n\n` +
    `üìç –û–∫—Ä—É–≥: ${districtName}\n\n` +
    `üìÇ **–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–º–æ—â–∏:**\n\n` +
    `‚Ä¢ ${CATEGORY_NAMES[CATEGORIES.CHILDREN]} - –ø–æ–º–æ—â—å –¥–µ—Ç—Å–∫–∏–º –¥–æ–º–∞–º, –º–Ω–æ–≥–æ–¥–µ—Ç–Ω—ã–º —Å–µ–º—å—è–º\n` +
    `‚Ä¢ ${CATEGORY_NAMES[CATEGORIES.ELDERLY]} - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–∂–∏–ª—ã—Ö –∏ –æ–¥–∏–Ω–æ–∫–∏—Ö –ª—é–¥–µ–π\n` +
    `‚Ä¢ ${CATEGORY_NAMES[CATEGORIES.DISABLED]} - –ø–æ–º–æ—â—å –ª—é–¥—è–º —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏\n` +
    `‚Ä¢ ${CATEGORY_NAMES[CATEGORIES.ANIMALS]} - –∑–∞–±–æ—Ç–∞ –æ –±–µ–∑–¥–æ–º–Ω—ã—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö, –ø—Ä–∏—é—Ç–∞—Ö\n` +
    `‚Ä¢ ${CATEGORY_NAMES[CATEGORIES.NATURE]} - —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã, –æ–∑–µ–ª–µ–Ω–µ–Ω–∏–µ\n`,
    { attachments: [keyboard] }
  );
}

async function showProfile(ctx) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (!user?.user_id) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  const userRequests = getUserRequests(user.user_id);
  const userResponses = getUserResponses(user.user_id);
  const requestsCount = userRequests.length;
  const responsesCount = userResponses.length;

  const keyboard = Keyboard.inlineKeyboard([
    [
      Keyboard.button.callback(`üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏ (${requestsCount})`, 'my_requests'),
      Keyboard.button.callback(`üì® –ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏ (${responsesCount})`, 'my_responses')
    ],
    [
      Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')
    ]
  ]);

  await ctx.reply(
    `üë§ **–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å**\n\n` +
    `üìõ –ò–º—è: ${user.first_name}\n` +
    `üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫: ${requestsCount}\n` +
    `üì® –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–ª–∏–∫–æ–≤: ${responsesCount}\n\n` +
    `–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∑–∞—è–≤–∫–∞–º–∏ –∏ –æ—Ç–∫–ª–∏–∫–∞–º–∏.`,
    { attachments: [keyboard] }
  );
}

async function showMyRequests(ctx, index = 0) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (!user?.user_id) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  const userRequests = getUserRequests(user.user_id);

  if (userRequests.length === 0) {
    const keyboard = Keyboard.inlineKeyboard([
      [Keyboard.button.callback('üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É', 'need_help')],
      [Keyboard.button.callback('üë§ –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å', 'back_to_profile')]
    ]);

    await ctx.reply(
      '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫.\n\n' +
      '–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É –æ –ø–æ–º–æ—â–∏?',
      { attachments: [keyboard] }
    );
    return;
  }

  if (index < 0) index = 0;
  if (index >= userRequests.length) index = userRequests.length - 1;

  userMyRequestsViewStates.set(user.user_id, index);

  const request = userRequests[index];
  const responses = getRequestResponses(request.id);

  let message = `üìã –í–∞—à–∞ –∑–∞—è–≤–∫–∞ ${index + 1} –∏–∑ ${userRequests.length}\n\n`;
  message += `üî∏ ID –∑–∞—è–≤–∫–∏: ${request.id}\n`;
  message += `üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${CATEGORY_NAMES[request.category]}\n`;
  message += `üìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[request.district]}\n`;
  message += `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${request.phone}\n`;
  message += `üìù –ü—Ä–æ–±–ª–µ–º–∞: ${request.problem}\n`;
  message += `‚≠ê –†–µ–π—Ç–∏–Ω–≥: ${request.rating}\n`;
  message += `üë• –û—Ç–∫–ª–∏–∫–æ–≤: ${responses.length}\n`;
  message += `‚è∞ –í—Ä–µ–º—è: ${new Date(request.timestamp).toLocaleString('ru-RU')}\n`;

  if (request.reserved) {
    message += `üîí –°—Ç–∞—Ç—É—Å: –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞\n`;
  } else {
    message += `üîì –°—Ç–∞—Ç—É—Å: –°–≤–æ–±–æ–¥–Ω–∞\n`;
  }

  const navigationButtons = [];

  if (index > 0) {
    navigationButtons.push(Keyboard.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', `my_prev_${index - 1}`));
  }

  if (index < userRequests.length - 1) {
    navigationButtons.push(Keyboard.button.callback('–î–∞–ª–µ–µ ‚û°Ô∏è', `my_next_${index + 1}`));
  }

  const actionButtons = [
    Keyboard.button.callback('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É', `delete_${request.id}`)
  ];

  const keyboardRows = [];
  if (navigationButtons.length > 0) {
    keyboardRows.push(navigationButtons);
  }
  keyboardRows.push(actionButtons);
  keyboardRows.push([
    Keyboard.button.callback('üë§ –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å', 'back_to_profile'),
    Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')
  ]);

  const keyboard = Keyboard.inlineKeyboard(keyboardRows);

  await ctx.reply(message, { attachments: [keyboard] });
}

async function showMyResponses(ctx, index = 0) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (!user?.user_id) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  const userResponses = getUserResponses(user.user_id);
  const data = loadData();

  if (userResponses.length === 0) {
    const keyboard = Keyboard.inlineKeyboard([
      [Keyboard.button.callback('üîç –ù–∞–π—Ç–∏ –∑–∞—è–≤–∫–∏', 'want_to_help')],
      [Keyboard.button.callback('üë§ –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å', 'back_to_profile')]
    ]);

    await ctx.reply(
      '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∫–ª–∏–∫–æ–≤.\n\n' +
      '–•–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏ –∑–∞—è–≤–∫–∏ –¥–ª—è –ø–æ–º–æ—â–∏?',
      { attachments: [keyboard] }
    );
    return;
  }

  if (index < 0) index = 0;
  if (index >= userResponses.length) index = userResponses.length - 1;

  const response = userResponses[index];
  const request = data.requests.find(req => req.id === response.request_id);

  if (!request) {
    await ctx.reply('–ó–∞—è–≤–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –≤—ã –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å, –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
    return;
  }

  let message = `üì® –í–∞—à –æ—Ç–∫–ª–∏–∫ ${index + 1} –∏–∑ ${userResponses.length}\n\n`;
  message += `üî∏ ID –æ—Ç–∫–ª–∏–∫–∞: ${response.id}\n`;
  message += `üìã –ó–∞—è–≤–∫–∞: ${request.problem.substring(0, 50)}...\n`;
  message += `üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${CATEGORY_NAMES[request.category]}\n`;
  message += `üìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[request.district]}\n`;
  message += `üë§ –ê–≤—Ç–æ—Ä: ${request.first_name}\n`;
  message += `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${request.phone}\n`;
  message += `‚è∞ –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: ${new Date(response.timestamp).toLocaleString('ru-RU')}\n\n`;
  message += `_–î–ª—è —Å–≤—è–∑–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∞–≤—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏_ üìû`;

  const navigationButtons = [];

  if (index > 0) {
    navigationButtons.push(Keyboard.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', `resp_prev_${index - 1}`));
  }

  if (index < userResponses.length - 1) {
    navigationButtons.push(Keyboard.button.callback('–î–∞–ª–µ–µ ‚û°Ô∏è', `resp_next_${index + 1}`));
  }

  const actionButtons = [
    Keyboard.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–∫–ª–∏–∫', `cancel_response_${request.id}`)
  ];

  const keyboardRows = [];
  if (navigationButtons.length > 0) {
    keyboardRows.push(navigationButtons);
  }
  keyboardRows.push(actionButtons);
  keyboardRows.push([
    Keyboard.button.callback('üë§ –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å', 'back_to_profile'),
    Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')
  ]);

  const keyboard = Keyboard.inlineKeyboard(keyboardRows);

  await ctx.reply(message, { attachments: [keyboard] });
}

async function showHelpRequest(ctx, index = 0, category = null, district = null) {
  const requests = getSortedRequests(category, district);
  const userId = ctx.update.callback?.user?.user_id || ctx.message?.sender?.user_id;

  if (!userId) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  if (requests.length === 0) {
    let filterText = '';
    if (category) filterText += ` –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${CATEGORY_NAMES[category]}"`;
    if (district) filterText += ` –≤ –æ–∫—Ä—É–≥–µ "${DISTRICT_NAMES[district]}"`;
    
    const keyboard = Keyboard.inlineKeyboard([
      [Keyboard.button.callback('üìÇ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é', `back_to_categories_help_${district}`)],
      [Keyboard.button.callback('üìç –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ–∫—Ä—É–≥', `back_to_districts_help`)],
      [Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start')]
    ]);

    await ctx.reply(
      `–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫${filterText}. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ! ü§ó`,
      { attachments: [keyboard] }
    );
    return;
  }

  if (index < 0) index = 0;
  if (index >= requests.length) index = requests.length - 1;

  userViewStates.set(userId, { index, category, district });

  const request = requests[index];
  const hasResponded = hasUserResponded(userId, request.id);

  let message = `üìã –ó–∞—è–≤–∫–∞ ${index + 1} –∏–∑ ${requests.length}\n\n`;
  message += `üî∏ ID –∑–∞—è–≤–∫–∏: ${request.id}\n`;
  message += `üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${CATEGORY_NAMES[request.category]}\n`;
  message += `üìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[request.district]}\n`;
  message += `üë§ –ò–º—è: ${request.first_name}\n`;
  message += `üìù –ü—Ä–æ–±–ª–µ–º–∞: ${request.problem}\n`;
  message += `‚≠ê –†–µ–π—Ç–∏–Ω–≥: ${request.rating}\n`;
  message += `‚è∞ –í—Ä–µ–º—è: ${new Date(request.timestamp).toLocaleString('ru-RU')}\n\n`;

  if (hasResponded) {
    message += `üìû **–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏:** ${request.phone}\n\n`;
    message += `_–í—ã —É–∂–µ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ —ç—Ç—É –∑–∞—è–≤–∫—É. –î–ª—è —Å–≤—è–∑–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω._ üìû`;
  } else {
    message += `_–ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è", —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–º–æ—á—å._`;
  }

  const navigationButtons = [];

  if (index > 0) {
    navigationButtons.push(Keyboard.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', `prev_${index - 1}_${category || ''}_${district || ''}`));
  }

  if (index < requests.length - 1) {
    navigationButtons.push(Keyboard.button.callback('–î–∞–ª–µ–µ ‚û°Ô∏è', `next_${index + 1}_${category || ''}_${district || ''}`));
  }

  const keyboardRows = [];
  if (navigationButtons.length > 0) {
    keyboardRows.push(navigationButtons);
  }

  if (!hasResponded) {
    keyboardRows.push([
      Keyboard.button.callback('ü§ù –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è', `respond_${request.id}`)
    ]);
  }

  const backButtons = [];
  if (category) {
    backButtons.push(Keyboard.button.callback('üìÇ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é', `back_to_categories_help_${district}`));
  }
  if (district) {
    backButtons.push(Keyboard.button.callback('üìç –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ–∫—Ä—É–≥', `back_to_districts_help`));
  }
  backButtons.push(Keyboard.button.callback('üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'back_to_start'));

  keyboardRows.push(backButtons);

  const keyboard = Keyboard.inlineKeyboard(keyboardRows);

  await ctx.reply(message, { attachments: [keyboard] });
}

// ========== –§–£–ù–ö–¶–ò–ò –î–ï–ô–°–¢–í–ò–ô ==========

async function deleteMyRequest(ctx, requestId) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (!user?.user_id) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  const success = deleteRequest(requestId, user.user_id);

  if (success) {
    await ctx.reply('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
    const userRequests = getUserRequests(user.user_id);
    if (userRequests.length > 0) {
      await showMyRequests(ctx, 0);
    } else {
      await showProfile(ctx);
    }
  } else {
    await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —É–∂–µ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞.');
    await showProfile(ctx);
  }
}

async function respondToRequest(ctx, requestId) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (!user?.user_id) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  if (hasUserResponded(user.user_id, requestId)) {
    await ctx.reply('‚ùå –í—ã —É–∂–µ –æ—Ç–∫–ª–∏–∫–∞–ª–∏—Å—å –Ω–∞ —ç—Ç—É –∑–∞—è–≤–∫—É.');
    return;
  }

  const data = loadData();
  const request = data.requests.find(req => req.id === requestId);

  if (!request) {
    await ctx.reply('‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
    return;
  }

  const success = reserveRequest(requestId, user.user_id);

  if (success) {
    await ctx.reply(
      `‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ –∑–∞—è–≤–∫—É!\n\n` +
      `üìã **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ:**\n` +
      `üë§ –ê–≤—Ç–æ—Ä: ${request.first_name}\n` +
      `üìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[request.district]}\n` +
      `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${request.phone}\n` +
      `üìù –ü—Ä–æ–±–ª–µ–º–∞: ${request.problem}\n\n` +
      `_–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–≤—Ç–æ—Ä–æ–º –∑–∞—è–≤–∫–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –ø–æ–º–æ—â–∏._`
    );

    try {
      await bot.api.sendMessageToUser(
        request.user_id,
        `üì® –ù–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.first_name}!\n\n` +
        `üìã –ó–∞—è–≤–∫–∞: ${request.problem}\n` +
        `üìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[request.district]}\n` +
        `üë§ –û—Ç–∫–ª–∏–∫–Ω—É–≤—à–∏–π—Å—è: ${user.first_name}\n\n` +
        `_–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∏–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –ø–æ–º–æ—â–∏._`
      );
    } catch (error) {}
  } else {
    await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –∑–∞—è–≤–∫—É. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞.');
  }
}

async function cancelResponse(ctx, requestId) {
  const user = ctx.update.callback?.user || ctx.message?.sender;
  if (!user?.user_id) {
    await ctx.reply('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  const success = cancelReservation(requestId, user.user_id);

  if (success) {
    await ctx.reply('‚úÖ –û—Ç–∫–ª–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω! –ó–∞—è–≤–∫–∞ —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ.');
    const userResponses = getUserResponses(user.user_id);
    if (userResponses.length > 0) {
      await showMyResponses(ctx, 0);
    } else {
      await showProfile(ctx);
    }
  } else {
    await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–∫–ª–∏–∫.');
    await showProfile(ctx);
  }
}

// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô ==========

bot.on('message_created', async (ctx) => {
  if (ctx.message.body.text && ctx.message.body.text.startsWith('/')) {
    return;
  }

  const user = ctx.message.sender;
  
  if (!hasUserAcceptedAgreement(user.user_id)) {
    await showUserAgreement(ctx);
    return;
  }

  const userState = userStates.get(user.user_id);

  if (!userState) return;

  try {
    if (userState.step === 'waiting_for_problem') {
      userState.problem = ctx.message.body.text;
      userState.step = 'waiting_for_phone';

      await ctx.reply(
        '–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏.\n\n' +
        'üì± **–§–æ—Ä–º–∞—Ç—ã –Ω–æ–º–µ—Ä–æ–≤:**\n' +
        '‚Ä¢ +7 (XXX) XXX-XX-XX\n' +
        '‚Ä¢ 8 (XXX) XXX-XX-XX\n' +
        '‚Ä¢ XXX-XXX-XX-XX\n\n' +
        '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä:'
      );

    } else if (userState.step === 'waiting_for_phone') {
      const phoneInput = ctx.message.body.text;

      if (!validatePhone(phoneInput)) {
        await ctx.reply(
          '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n\n' +
          'üì± **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**\n' +
          '‚Ä¢ +7 (XXX) XXX-XX-XX\n' +
          '‚Ä¢ 8 (XXX) XXX-XX-XX\n' +
          '‚Ä¢ XXX-XXX-XX-XX\n\n' +
          '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –µ—â–µ —Ä–∞–∑:'
        );
        return;
      }

      const formattedPhone = formatPhone(phoneInput);
      const newRequest = addRequest(user, userState.problem, formattedPhone, userState.category, userState.district);
      userStates.delete(user.user_id);

      const returnKeyboard = Keyboard.inlineKeyboard([
        [Keyboard.button.callback('‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', 'return_after_request')]
      ]);

      await ctx.reply(
        '‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –í–æ–ª–æ–Ω—Ç–µ—Ä—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n' +
        '–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n' +
        `üë§ –ò–º—è: ${user.first_name}\n` +
        `üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${CATEGORY_NAMES[userState.category]}\n` +
        `üìç –û–∫—Ä—É–≥: ${DISTRICT_NAMES[userState.district]}\n` +
        `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${formattedPhone}\n` +
        `üìù –ü—Ä–æ–±–ª–µ–º–∞: ${userState.problem}`,
        { attachments: [returnKeyboard] }
      );
    }
  } catch (error) {
    await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. ‚ùå');
    userStates.delete(user.user_id);
  }
});

// ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

bot.start();
